<!DOCTYPE html>
<html>
   <head>
      <title>Cards</title>
      <meta charset="UTF-8">
      <style>
         td.card{
            width:100px;
            height:140px;
            border:1px solid blue;
            border-radius:10px;
            text-align:center;
            font-size:36px;
            background-color:white;
            box-shadow:rgb(128,128,128)5px 5px;
         }
         td.back{
            background-image: url("card.png");
            background-size: 100px 140px;
         }
      </style>
      <script>
         "use strict";

         Array.prototype.shuffle = function(){
            var i = this.length;
            while(i){
               var j = Math.floor(Math.random() * i);
               var t = this[--i];
               this[i] = this[j];
               this[j] = t;
            }
            return this;
         }

         var timer = NaN,score = 0,myturn = true,clickable = true,flipTimer,prevCard,startTime;

         function init(){
            var table = document.getElementById("table");
            var cards = [];
            for(var i = 1;i <= 10;i++){
               cards.push(i);
               cards.push(i);
            }
            cards.shuffle();

            for(var i = 0; i < 4; i++){
               var tr = document.createElement("tr");
               for(var j = 0;j < 5;j++){
                  var td = document.createElement("td");
                  td.className = "card back";
                  td.number = cards[i * 5 + j];
                  td.pass = i * 5 + j
                  td.onclick = clicked;
                  tr.appendChild(td);
               }
               table.appendChild(tr);
            }

            startTime = new Date();
            timer = setInterval(tick,1000);
         }

         function tick(){
            var now = new Date();
            var elapsed = Math.floor((now.getTime() - startTime.getTime()) / 1000);
            document.getElementById("time").textContent = elapsed;
         }

         function flip(e){
            var src = e.srcElement;
            if(flipTimer || src.textContent != ""){
               return;
            }
            var num = src.number;
            src.className = "card";
            src.textContent = num;

            if(prevCard == null){
               prevCard = src;
               clickable = true;
               return;
            }

            if(prevCard.number == num){
               if(++score == 10){
                  clearInterval(timer);
               }
               prevCard = null;
               clearTimeout(flipTimer);
               clickable = true;
            }else{
               flipTimer = setTimeout(function(){
                  src.className = "card back";
                  src.textContent = "";
                  prevCard.className = "card back";
                  prevCard.textContent = "";
                  prevCard = null;
                  flipTimer = NaN;
                  myturn = !myturn;
                  clickable = true;
               },1000);
            }
         }

         async function enemyFlip(){
            let randamNum = Math.floor( Math.random() * 20 );
            let td = document.querySelectorAll("td");
            var src = td[randamNum];
            if(flipTimer || src.textContent != ""){
               return;
            }
            var num = src.number;
            src.className = "card";
            src.textContent = num;

            if(prevCard == null){
               prevCard = src;
               return;
            }

            if(prevCard.number == num){
               if(++score == 10){
                  clearInterval(timer);
               }
               prevCard = null;
               clearTimeout(flipTimer);
            }else{
               flipTimer = setTimeout(function(){
                  src.className = "card back";
                  src.textContent = "";
                  prevCard.className = "card back";
                  prevCard.textContent = "";
                  prevCard = null;
                  flipTimer = NaN;
                  myturn = !myturn;
                  console.log("マイターン！");
                  return "resolve";
               },1000);
            }
         }

         function clicked(e){
            if(clickable == false){
               console.log("ng");
               return;
            }
            if(!myturn){
               clickable = false;
               let intervalCount = 0;
               let enemyAct = setInterval(() =>{
                  enemyFlip().then();
                  intervalCount++;
                  if(intervalCount == 2){
                     clearInterval(enemyAct);
                     clickable = true;
                     console.log("クリッカブル");
                  };
               },1000);
            }else{
               clickable = false;
               flip(e);
            }
         }
      </script>
   </head>
   <body onload="init()">
      <table id ="table"></table>
      <h2>
         経過時間:<span id="time">0</span>秒
      </h2>
   </body>
</html>