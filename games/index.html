<!DOCTYPE html>
<html>
   <head>
      <title>Cards</title>
      <meta charset="UTF-8">
      <style>
         td.card{
            width:100px;
            height:140px;
            border:1px solid blue;
            border-radius:10px;
            text-align:center;
            font-size:36px;
            background-color:white;
            box-shadow:rgb(128,128,128)5px 5px;
         }
         td.back{
            background-image: url("card.png");
            background-size: 100px 140px;
         }
         #turnState{
            margin-top: 0px;
            font-size:18px;
            font-weight: bold;
         }
         .timeText{
            margin-bottom: 0px;
            font-weight: bold;
         }
         .scoreArea{
            margin:0;
            padding:0;
            margin-top: 10px;
         }
      </style>
      <script>
         "use strict";

         Array.prototype.shuffle = function(){
            var i = this.length;
            while(i){
               var j = Math.floor(Math.random() * i);
               var t = this[--i];
               this[i] = this[j];
               this[j] = t;
            }
            return this;
         }

         var timer = NaN,score = 0,myturn = true,clickable = true,flipTimer,prevCard,prevPass,firstPass,startTime,turnState;
         let myScore = 0;
         let enemyScore = 0;
         let localPass = [];
         //表になっているカード
         let openedPass = [];
         //既に開かれたが、まだ表になっていないカード
         let openedNum = [];
         function init(){
            turnState = document.getElementById("turnState");
            var table = document.getElementById("table");
            var cards = [];
            for(var i = 1;i <= 10;i++){
               cards.push(i);
               cards.push(i);
            }
            cards.shuffle();

            for(var i = 0; i < 4; i++){
               var tr = document.createElement("tr");
               for(var j = 0;j < 5;j++){
                  var td = document.createElement("td");
                  td.className = "card back";
                  td.number = cards[i * 5 + j];
                  td.pass = i * 5 + j
                  td.opened = false;
                  td.onclick = clicked;
                  tr.appendChild(td);
               }
               table.appendChild(tr);
            }

            startTime = new Date();
            timer = setInterval(tick,1000);
         }

         function tick(){
            var now = new Date();
            var elapsed = Math.floor((now.getTime() - startTime.getTime()) / 1000);
            document.getElementById("time").textContent = elapsed;
         }

         function turnChange(){
            myturn = !myturn;
            if(myturn){
               turnState.textContent = "自分のターン";
            }else{
               turnState.textContent = "相手のターン";
            }
            if(openedPass == 20){
               turnState.textContent = "ゲームエンド！";
               clearInterval(timer);
            }
         }

         function scoreChange(){
            document.getElementById("myScore").textContent = myScore;
            document.getElementById("enemyScore").textContent = enemyScore;
         }

         function flip(e){
            var src = e.srcElement;
            if(flipTimer || src.textContent != ""){
               clickable = true;
               return;
            }
            var num = src.number;
            src.className = "card";
            localPass.push(src.pass);
            src.textContent = num;

            if(prevCard == null){
               prevCard = src;
               clickable = true;
               return;
            }

            if(prevCard.number == num){
               if(++score == 10){
                  clearInterval(timer);
               }
               prevCard = null;
               clearTimeout(flipTimer);
               openedPass = openedPass.concat(localPass);
               console.log(openedPass);
               localPass = [];
               scoreChange();
               clickable = true;
            }else{
               flipTimer = setTimeout(function(){
                  src.className = "card back";
                  src.textContent = "";
                  prevCard.className = "card back";
                  prevCard.textContent = "";
                  prevCard = null;
                  flipTimer = NaN;
                  turnChange();
                  localPass = [];
                  myScore = myScore + 2;
                  clickable = true;
               },1000);
            }
         }

         function enemyFlip(){
            let randomNum = Math.floor( Math.random() * 20 );
            //表になっているカードは相手の開示対象から除外する
            while(openedPass.includes(randomNum) || randomNum == firstPass){
               if(openedPass.length == 20){
                  return;
               }
               if(randomNum == 19){
                  randomNum = 0;
               }else{
                  randomNum++;
               }
            }
            let td = document.querySelectorAll("td");

            
            //2枚目、１枚目と同じ数字のカードを選んで開示するパターン
            if(prevCard){
               if(randomNum >= 10){
                  let target = prevCard.number;
                  console.log(target);
                  let i = 0;
                  console.log(td[i].number);
                  while(i <= 19){
                     console.log(i);
                     if(i !== prevCard.pass){
                        if(td[i].number == target){
                           var src = td[i];
                           var num = src.number;
                           localPass.push(src.pass);
                           src.className = "card";
                           src.textContent = num;
                           console.log("発動");
                           prevCard = null;
                           openedPass = openedPass.concat(localPass);
                           console.log(openedPass);
                           localPass = [];
                           scoreChange();
                           firstPass = null;
                           clearTimeout(flipTimer);
                           return;
                        }else{
                           i++;
                        }
                     }else{
                        i++;
                     }
                  }
               }
            }
            var src = td[randomNum];
            if(flipTimer || src.textContent != ""){
               return;
            }
            var num = src.number;
            localPass.push(src.pass);
            src.className = "card";
            src.textContent = num;

            //1枚目
            if(prevCard == null){
               prevCard = src;
               firstPass = src.pass;
               return;
            }

            //2枚目
            if(prevCard.number == num){
               if(++score == 10){
                  clearInterval(timer);
               }
               prevCard = null;
               openedPass = openedPass.concat(localPass);
               console.log(openedPass);
               localPass = [];
               firstPass = null;
               clearTimeout(flipTimer);
            }else{
               flipTimer = setTimeout(function(){
                  src.className = "card back";
                  src.textContent = "";
                  prevCard.className = "card back";
                  prevCard.textContent = "";
                  prevCard = null;
                  flipTimer = NaN;
                  turnChange();
                  localPass = [];
                  firstPass = null;
                  console.log("マイターン！");
               },1000);
            }
         }
         function stopEnemyFlip(){
            enemyFlip();
            setTimeout(function(){
            clickable = true;
            console.log("クリッカブル");
            },1500);
         }
            
         function clicked(e){
            if(clickable == false){
               console.log("ng");
               return;
            }
            if(!myturn){
               clickable = false;
               let intervalCount = 0;
               let enemyAct = setInterval(() =>{
                  intervalCount++;
                  if(intervalCount == 2){
                     clearInterval(enemyAct);
                     stopEnemyFlip();
                     return;
                  };
                  enemyFlip();
               },1000);
            }else{
               clickable = false;
               flip(e);
            }
         }
      </script>
   </head>
   <body onload="init()">
      <table id ="table"></table>
      <p class="timeText">
         経過時間:<span id="time">0</span>秒
      </p>
      <p id="turnState"></p>
      <p class="scoreArea"><span id="myScore">0</span></p>
      <p class="scoreArea"><span id="enemyScore">0</span></p>
   </body>
</html>